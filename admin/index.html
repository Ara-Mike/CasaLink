<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CasaLink - Admin Login</title>
    <!-- Cache control headers (reduced to just one) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="manifest" href="../manifest.json">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Add a loading indicator */
        .login-loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }
        
        .login-loading.active {
            display: flex;
        }
        
        .login-loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1A73E8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Logout protection overlay */
        .logout-protection {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .logout-protection.active {
            display: flex;
        }
        
        .protection-message {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .protection-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
</head>
<body class="admin-login-page">
    <!-- Logout protection overlay -->
    <div class="logout-protection" id="logoutProtection">
        <div class="protection-message">
            <h3 style="margin-top: 0; color: #dc2626;">
                <i class="fas fa-exclamation-triangle"></i> Logout in Progress
            </h3>
            <p>Please wait while we securely log you out...</p>
            <div class="login-loading-spinner" style="margin: 20px auto;"></div>
            <p><small>If this takes more than 10 seconds, please refresh the page.</small></p>
            <div class="protection-buttons">
                <button class="btn btn-outline" onclick="forceCleanup()">
                    <i class="fas fa-broom"></i> Force Cleanup
                </button>
                <button class="btn btn-primary" onclick="refreshPage()">
                    <i class="fas fa-sync-alt"></i> Refresh Page
                </button>
            </div>
        </div>
    </div>
    
    <!-- Loading overlay -->
    <div class="login-loading" id="loginLoading">
        <div class="login-loading-spinner"></div>
        <p>Processing login...</p>
    </div>
    
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>CasaLink Admin</h1>
                <p>Platform Management System</p>
            </div>
            
            <form id="adminLoginForm" class="login-form">
                <div class="form-group">
                    <label for="adminEmail">Admin Email</label>
                    <input type="email" id="adminEmail" required 
                           placeholder="admin@casalink.com" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" required 
                           placeholder="Enter your password" autocomplete="current-password">
                </div>
                
                <div class="form-group">
                    <label for="adminKey">Admin Key (Optional)</label>
                    <input type="password" id="adminKey" 
                           placeholder="Additional security key">
                </div>
                
                <button type="submit" class="btn btn-primary btn-block" id="loginSubmitBtn">
                    Sign In as Admin
                </button>
                
                <div class="login-footer">
                    <a href="../index.html">‚Üê Back to Main Site</a>
                    <br>
                    <small style="color: #666; margin-top: 10px; display: block;">
                        <a href="javascript:clearAllStorage()" style="color: #dc2626;">
                            <i class="fas fa-trash-alt"></i> Clear all storage
                        </a>
                    </small>
                </div>
            </form>
            
            <div id="adminLoginError" class="alert alert-error hidden"></div>
        </div>
        
        <div class="login-info">
            <h3>Admin Access Only</h3>
            <p>This portal is restricted to authorized administrators only.</p>
            <p>Unauthorized access is prohibited.</p>
            
            <!-- Status indicator -->
            <div id="loginStatus" style="margin-top: 20px; padding: 10px; border-radius: 6px; background: #f8f9fa; display: none;">
                <small id="statusText"></small>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Admin Auth Script -->
    <script src="../js/admin/adminAuth.js"></script>
    
    <script>
        // Add the force logout function - FIXED VERSION
        function forceLogout() {
            console.log('üî¥ Force logout initiated');
            
            // Show protection overlay
            showLogoutProtection();
            
            try {
                // Set a short-lived cookie flag to prevent redirect loops
                document.cookie = 'casalink_redirected=1; max-age=5; path=/'; // Only 5 seconds
            } catch (e) {
                console.warn('Could not set cookie flag', e);
            }
            
            // Clear storages
            localStorage.clear();
            sessionStorage.clear();
            
            // Clear cookies except our guard cookie
            document.cookie.split(";").forEach(function(c) {
                const name = c.split('=')[0].trim();
                if (name && name !== 'casalink_redirected') {
                    document.cookie = name + "=;expires=" + new Date(0).toUTCString() + ";path=/";
                }
            });
            
            // Check if we already have the cookie to prevent multiple redirects
            if (document.cookie.includes('casalink_redirected=1')) {
                console.log('‚úÖ Redirect guard present, performing single redirect');
                setTimeout(() => {
                    window.location.replace('index.html?force_logout=true&t=' + Date.now());
                }, 300);
            } else {
                // Set cookie and redirect
                document.cookie = 'casalink_redirected=1; max-age=5; path=/';
                setTimeout(() => {
                    window.location.replace('index.html?force_logout=true&t=' + Date.now());
                }, 300);
            }
        }
        
        function showLogoutProtection() {
            document.getElementById('logoutProtection').classList.add('active');
        }
        
        function hideLogoutProtection() {
            document.getElementById('logoutProtection').classList.remove('active');
        }
        
        function forceCleanup() {
            console.log('Force cleanup initiated');
            
            // Set short-lived cookie to prevent reload loop
            try {
                document.cookie = 'casalink_redirected=1; max-age=5; path=/';
            } catch (e) {
                console.warn('Could not set cookie flag', e);
            }
            
            // Clear storage
            localStorage.clear();
            sessionStorage.clear();
            
            // Clear cookies (do NOT remove casalink_redirected)
            document.cookie.split(";").forEach(function(c) {
                const name = c.split('=')[0].trim();
                if (name && name !== 'casalink_redirected') {
                    document.cookie = name + "=;expires=" + new Date(0).toUTCString() + ";path=/";
                }
            });
            
            // Redirect once
            setTimeout(() => {
                window.location.replace('index.html?cleanup=true&t=' + Date.now());
            }, 300);
        }
        
        function refreshPage() {
            window.location.reload();
        }
        
        function clearAllStorage() {
            if (confirm('Clear all browser storage? This will log you out from all sessions.')) {
                localStorage.clear();
                sessionStorage.clear();
                
                // Clear all cookies
                document.cookie.split(";").forEach(function(c) {
                    const name = c.split('=')[0].trim();
                    document.cookie = name + "=;expires=" + new Date(0).toUTCString() + ";path=/";
                });
                
                alert('Storage cleared. Refreshing page...');
                setTimeout(() => {
                    window.location.reload();
                }, 300);
            }
        }
        
        // Main initialization - SIMPLIFIED
        (function() {
            console.log('üîê Admin login page loading...');
            
            // Check for force logout parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('force_logout') || urlParams.has('cleanup')) {
                console.log('Force logout/cleanup detected');
                
                // Clear storage
                localStorage.clear();
                sessionStorage.clear();
                
                // Clean URL
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                // Show success message
                const statusDiv = document.getElementById('loginStatus');
                const statusText = document.getElementById('statusText');
                if (statusDiv && statusText) {
                    statusDiv.style.display = 'block';
                    statusText.innerHTML = '<i class="fas fa-check-circle"></i> Successfully logged out. All sessions cleared.';
                    statusDiv.style.background = '#d1fae5';
                    statusDiv.style.borderLeft = '3px solid #10b981';
                }
            }
            
            // Check for logout parameter
            if (urlParams.has('logout')) {
                console.log('Normal logout detected');
                
                // Clear session
                localStorage.removeItem('admin_session');
                
                // Clean URL
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                // Show logout message
                const statusDiv = document.getElementById('loginStatus');
                const statusText = document.getElementById('statusText');
                if (statusDiv && statusText) {
                    statusDiv.style.display = 'block';
                    statusText.innerHTML = '<i class="fas fa-check-circle"></i> Successfully logged out.';
                    statusDiv.style.background = '#d1fae5';
                    statusDiv.style.borderLeft = '3px solid #10b981';
                    
                    // Remove after 5 seconds
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            }
            
            // Clear any pending redirect timeouts
            if (window.redirectTimeout) {
                clearTimeout(window.redirectTimeout);
                delete window.redirectTimeout;
            }
            
            // Check for existing session (for display only)
            const session = localStorage.getItem('admin_session');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    const statusDiv = document.getElementById('loginStatus');
                    const statusText = document.getElementById('statusText');
                    
                    if (statusDiv && statusText) {
                        statusDiv.style.display = 'block';
                        statusText.innerHTML = `<i class="fas fa-info-circle"></i> Detected previous session for ${sessionData.email}. Click login to continue.`;
                        statusDiv.style.background = '#e3f2fd';
                        statusDiv.style.borderLeft = '3px solid #1A73E8';
                    }
                } catch (e) {
                    // Invalid session data
                    localStorage.removeItem('admin_session');
                }
            }
        })();
        
        // Form submission handler - SIMPLIFIED
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('adminLoginForm');
            const loginLoading = document.getElementById('loginLoading');
            const loginSubmitBtn = document.getElementById('loginSubmitBtn');
            
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Show loading
                    if (loginLoading) {
                        loginLoading.classList.add('active');
                    }
                    if (loginSubmitBtn) {
                        loginSubmitBtn.disabled = true;
                        loginSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
                    }
                    
                    // Clear any previous errors
                    const errorElement = document.getElementById('adminLoginError');
                    if (errorElement) {
                        errorElement.textContent = '';
                        errorElement.classList.add('hidden');
                    }
                    
                    // Wait a moment to ensure adminAuth is loaded
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    // Check if adminAuthInstance exists
                    if (!window.adminAuthInstance) {
                        // Try to initialize it
                        try {
                            window.adminAuthInstance = new window.AdminAuthClass();
                            await new Promise(resolve => setTimeout(resolve, 500));
                        } catch (error) {
                            showError('Authentication system not loaded. Please refresh the page.');
                            hideLoading();
                            return;
                        }
                    }
                    
                    // Submit the form through adminAuth
                    if (window.adminAuthInstance && typeof window.adminAuthInstance.handleLogin === 'function') {
                        try {
                            await window.adminAuthInstance.handleLogin(e);
                        } catch (error) {
                            console.error('Login error:', error);
                            showError(error.message || 'Login failed');
                            hideLoading();
                        }
                    } else {
                        showError('Login system not available');
                        hideLoading();
                    }
                });
            }
            
            function showError(message) {
                const errorElement = document.getElementById('adminLoginError');
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.classList.remove('hidden');
                    
                    // Scroll to error
                    errorElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    alert('Login Error: ' + message);
                }
            }
            
            function hideLoading() {
                if (loginLoading) {
                    loginLoading.classList.remove('active');
                }
                if (loginSubmitBtn) {
                    loginSubmitBtn.disabled = false;
                    loginSubmitBtn.innerHTML = 'Sign In as Admin';
                }
            }
            
            // Auto-hide loading after timeout (safety)
            setTimeout(() => {
                hideLoading();
            }, 10000);
            
            // Debug: Log adminAuth status
            console.log('adminAuthInstance status:', window.adminAuthInstance ? 'Loaded' : 'Not loaded');
        });
        
        // Prevent form autofill issues
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                console.log('Page loaded from cache, refreshing form state');
                document.getElementById('adminLoginForm')?.reset();
            }
        });
        
        // Add global keyboard shortcut for force logout (Ctrl+Alt+L)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.altKey && e.key === 'l') {
                e.preventDefault();
                if (confirm('Force logout and clear all sessions?')) {
                    forceLogout();
                }
            }
        });
    </script>

    <script>
        // Enhanced login page initialization - SIMPLIFIED
        (function() {
            console.log('Login page initialization...');
            
            // Clear any logout flags from sessionStorage
            sessionStorage.removeItem('admin_logout');
            
            // Check for logout parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('logout')) {
                console.log('Logout detected, performing cleanup...');
                
                // Clear any remaining data
                localStorage.removeItem('admin_session');
                
                // Remove logout parameter from URL for cleaner appearance
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                // Show logout message
                const statusDiv = document.getElementById('loginStatus');
                const statusText = document.getElementById('statusText');
                if (statusDiv && statusText) {
                    statusDiv.style.display = 'block';
                    statusText.innerHTML = '<i class="fas fa-check-circle"></i> Successfully logged out.';
                    statusDiv.style.background = '#d1fae5';
                    statusDiv.style.borderLeft = '3px solid #10b981';
                    
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            }
            
            // Monitor adminAuth initialization
            let authCheckCount = 0;
            const maxAuthChecks = 10;
            
            function checkAuthInitialization() {
                if (authCheckCount >= maxAuthChecks) {
                    console.log('Max auth checks reached');
                    return;
                }
                
                authCheckCount++;
                
                if (!window.adminAuthInstance) {
                    console.log(`Auth check ${authCheckCount}: adminAuthInstance not found`);
                    setTimeout(checkAuthInitialization, 500);
                } else if (adminAuthInstance.isInitialized === false) {
                    console.log(`Auth check ${authCheckCount}: adminAuthInstance not initialized`);
                    setTimeout(checkAuthInitialization, 500);
                } else {
                    console.log('‚úÖ adminAuth ready');
                }
            }
            
            // Start checking
            setTimeout(checkAuthInitialization, 1000);
            
            // Add real-time form validation
            const emailField = document.getElementById('adminEmail');
            const passwordField = document.getElementById('adminPassword');
            
            if (emailField) {
                emailField.addEventListener('input', function() {
                    const errorElement = document.getElementById('adminLoginError');
                    if (errorElement && !errorElement.classList.contains('hidden')) {
                        errorElement.classList.add('hidden');
                    }
                });
            }
            
            if (passwordField) {
                passwordField.addEventListener('input', function() {
                    const errorElement = document.getElementById('adminLoginError');
                    if (errorElement && !errorElement.classList.contains('hidden')) {
                        errorElement.classList.add('hidden');
                    }
                });
            }
            
            // Add enter key support
            const adminKeyField = document.getElementById('adminKey');
            if (passwordField) {
                passwordField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('adminLoginForm').dispatchEvent(new Event('submit'));
                    }
                });
            }
            
            if (adminKeyField) {
                adminKeyField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('adminLoginForm').dispatchEvent(new Event('submit'));
                    }
                });
            }
        })();
    </script>
</body>
</html>